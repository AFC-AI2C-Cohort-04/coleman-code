# azure variables
RG_NAME=rg_main
LOCATION=eastus2
VM_NAME=vm_main
VM_SIZE=Standard_B2s
USERNAME=cloudadmin
PASSWORD=<PASSWORD>

# create group and vm
az group create --name $RG_NAME --location $LOCATION
az vm create \
  --resource-group $RG_NAME\
  --name $VM_NAME \
  --image Ubuntu2204 \
  --size $VM_SIZE \
  --admin-username $USERNAME \
  --admin-password $PASSWORD \
  --location $LOCATION

# open ports
az vm open-port --resource-group $RG_NAME --name $VM_NAME --port 22 --priority 1001
az vm open-port --resource-group $RG_NAME --name $VM_NAME --port 8000 --priority 1002
az vm open-port --resource-group $RG_NAME --name $VM_NAME --port 8080 --priority 1003

# ssh
PUBLIC_IP=$(az vm show -d -g $RG_NAME -n $VM_NAME --query publicIps -o tsv)
echo -e "\nVM: $VM_NAME\nPublic IP Address: $PUBLIC_IP\n"
ssh $USERNAME@$PUBLIC_IP

# get handout
wget https://cloudnativehandout.blob.core.windows.net/project1/handout.tar.gz
tar -xvzf handout.tar.gz

# get terraform
sudo apt-get update && sudo apt-get install -y gnupg software-properties-common
wget -O- https://apt.releases.hashicorp.com/gpg | \
gpg --dearmor | \
sudo tee /usr/share/keyrings/hashicorp-archive-keyring.gpg
gpg --no-default-keyring \
--keyring /usr/share/keyrings/hashicorp-archive-keyring.gpg \
--fingerprint
echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] \
https://apt.releases.hashicorp.com $(lsb_release -cs) main" | \
sudo tee /etc/apt/sources.list.d/hashicorp.list
sudo apt update
sudo apt-get install terraform

# get azure cli and login
curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
az login --use-device-code

# get maven, kubectl, and helm
sudo apt-get install maven openjdk-17-jdk openjdk-17-jre jq -y
curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

# set-up monolith db (23~30 minutes)
cd ~/handout/cloudchat/terraform-setup/task1-monolith_data_tier
terraform init
terraform apply -var-file="secret.tfvars"

# load terraform outputs into variables
MYSQL_HOST=$(terraform output mysql_fqdn)
MYSQL_USER=$(terraform output mysql_admin_username)
MYSQL_PASSWORD=$(terraform output mysql_admin_password)
SPRING_REDIS_HOST=$(terraform output redis_hostname)
SPRING_REDIS_PASSWORD=$(terraform output redis_primary_access_key)
SPRING_REDIS_PORT=$(terraform output redis_port)

# export variables
export MYSQL_HOST
export MYSQL_USER
export MYSQL_PASSWORD
export SPRING_REDIS_HOST
export SPRING_REDIS_PASSWORD
export SPRING_REDIS_PORT

# build application
cd ~/handout/cloudchat/task1-monolith
mvn clean package # [[ error ]]
java -jar ./target/cloudchat-1.0.0.jar
